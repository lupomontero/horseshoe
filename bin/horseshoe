#!/usr/bin/env node

var
  path = require('path'),
  Stream = require('stream'),
  nopt = require("nopt"),
  colors = require('colors'),
  JSONStream = require('JSONStream'),
  horseshoe = require('../index'),
  argv = process.argv.slice(2),

  knownOpts = {
    subject: String,
    text: String,
    html: String,
    tmpl: String,
    tmplPath: [ path, false ],
    data: String,
    conf: [ path, false ],
    json: Boolean,
    colors: Boolean,
    version: Boolean
  },

  shorthands = {
    s: [ '--subject' ],
    x: [ '--text' ],
    m: [ '--html' ],
    t: [ '--tmpl' ],
    p: [ '--tmplPath' ],
    d: [ '--data' ],
    c: [ '--conf' ],
    j: [ '--json' ],
    n: [ '--no-colors' ],
    "?": [ '--help' ],
    h: [ '--help' ],
    v: [ '--version' ]
  },

  defaults = {
    subject: null,
    text: null,
    html: null,
    tmpl: null,
    tmplPath: null,
    data: null,
    conf: process.env.HOME + '/.horseshoe.json',
    json: false,
    colors: true,
    help: false,
    version: false
  },

  options = nopt(knownOpts, shorthands);

Object.keys(defaults).forEach(function (k) {
  if (!options.hasOwnProperty(k)) { options[k] = defaults[k]; }
});

if (options.version) {
  console.log(require("../package.json").version);
  process.exit(0);
}

// Disable colouring if asked to do so...
if (!options.colors) { colors.mode = 'none'; }

if (options.help || !options.argv.remain.length) {
  console.log([
    '',
    'Usage:'.bold,
    '',
    'horseshoe [ <options> ] <email1> [ <email2> ... ]',
    '',
    'Options:'.bold,
    '',
    '-s  ' + '--subject     '.grey + 'The message subject.',
    '-x  ' + '--text        '.grey + 'The plain text message body.',
    '-m  ' + '--html        '.grey + 'HTML content.',
    '-t  ' + '--tmpl        '.grey + 'Handlebars template.',
    '-p  ' + '--tmplPath    '.grey + 'Path to Handlebars template files.',
    '-d  ' + '--data        '.grey + 'Data to be used as context for Handlebars template.',
    '-c  ' + '--conf        '.grey + 'Path to config file. Default is $HOME/.horseshoe.json',
    '-j  ' + '--json        '.grey + 'Output in JSON format.',
    '-n  ' + '--no-colors   '.grey + 'Dont do output colouring.',
    '-h  ' + '--help        '.grey + 'Show this screen you are looking at.',
    '-v  ' + '--version     '.grey + 'Show horseshoe\'s version number.',
    '',
    'Examples:'.bold,
    '',
    '1. Send plain text email using options:',
    '',
    'horseshoe ' + '-s "the subject"'.green + ' -x "simple text body"'.yellow +
      ' someone@somewhere.com'.cyan,
    '',
    '2. Send plain text email piping body into horseshoe:',
    '',
    'echo ' + '"the body"'.green + ' | horseshoe' + ' -s "the subject"'.yellow +
      ' someone@somewhere.com'.cyan,
    '',
    '3. Send email using template passing data as argument:',
    '',
    'horseshoe ' + '-s "the subject"'.green + ' -t "foo"'.yellow +
      ' -d \'{"name":"Lupo"}\''.magenta + ' someone@somewhere.com'.cyan,
    ''
  ].join('\n'));
  process.exit(0);
}

// We create a readable stream to be used for output.
var res = new Stream();
res.readable = true;
res.on('error', function (err) {
  // Here we are assuming that err has a `message` property. Maybe we should
  // actually check this.
  console.error('error: '.red + err.message.red);
  process.exit(1);
});
res.on('warning', function (buf) {
  console.error('warning: '.yellow + buf.yellow);
});
res.on('data', function (buf) {
  console.log(buf);
});
res.on('end', function (buf) {
  console.log(buf);
  process.exit(0);
});

// Try to load config file and make sure it has a valid transport type.
try {
  var config = require(options.conf);
  if ([ 'Sendmail', 'SMTP', 'SES' ].indexOf(config.type) < 0) {
    throw new Error('Config file MUST contain a "type" property with a value ' +
                    'of Sendmail, SMTP or SES.');
  }
  // Override `tmplPath` is passed as argument.
  if (options.tmplPath) { config.options.tmplPath = options.tmplPath; }
} catch (err) {
  res.emit('warning', [
    'In order to use horseshoe you need to have at least one configuration ',
    'file. The default location for this file is ' + process.env.HOME +
      '/.horseshoe.json.',
    'You can specify a different config file with the ' + '--conf'.bold +
      ' option. See ',
    'horseshoe --help'.bold + ' for more on this.',
    '',
    'This file should look something like this:',
    '',
    JSON.stringify({
      type: 'SMTP',
      options: {
        sender: 'Someone <you@example.com>',
        host: 'mail.example.com',
        port: 587,
        auth: {
          user: 'you@example.com',
          pass: 'xxxxxx'
        }
      }
    }, null, '  '),
    '',
    'More info about all the different options here:',
    'https://github.com/lupomontero/horseshoe',
    ''
  ].join('\n'));
  res.emit('error', err);
}

// Abstract horseshoe's `mailer.send()`.
function send(msg) {
  horseshoe(config.type, config.options).send(msg, function (err, response) {
    if (err) { return res.emit('error', err); }
    if (response.failedRecipients.length) {
      response.failedRecipients.forEach(function (recipient) {
        res.emit('warning', 'Error sending to ' + JSON.stringify(recipient));
      });
    } else {
      res.emit('end', response.messageId);
    }
  });
}

// Handle cases where we don't expect anything from  stdin...
if (options.text && options.subject) {
  send({
    to: options.argv.remain.join(','),
    subject: options.subject,
    text: options.text
  });
} else if (options.html) {
  send({
    to: options.argv.remain.join(','),
    subject: options.subject,
    html: options.html
  });
} else if (options.tmpl && options.data) {
  // Put this block in a try/catch block as `JSON.parse` could throw.
  try {
    var data = JSON.parse(options.data);
    send({
      to: options.argv.remain.join(','),
      subject: options.subject,
      template: options.tmpl,
      data: data
    });
  } catch (err) {
    res.emit('error', err);
  }
} else if (options.tmpl) {
  // Handle template data as input from stdin.
  var parser = JSONStream.parse(true);
  process.stdin.resume();
  process.stdin.setEncoding('utf8');
  process.stdin.pipe(parser);
  parser.on('error', function (err) {
    console.error(err);
  });
  parser.on('data', function (chunk) {
    process.stdout.write('data: ' + chunk);
  });
  parser.on('end', function () {
    process.stdout.write('end');
  });
} else {
  // Use stdin as message body.
  var text = '';
  process.stdin.resume();
  process.stdin.setEncoding('utf8');
  process.stdin.on('data', function (buf) { text += buf; });
  process.stdin.on('end', function () {
    send({
      subject: options.subject,
      to: options.argv.remain.join(','),
      text: text.trim()
    });
  });
}
