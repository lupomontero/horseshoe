#!/usr/bin/env node

var
  path = require('path'),
  nopt = require("nopt"),
  colors = require('colors'),
  argv = process.argv.slice(2),

  knownOpts = {
    subject: String,
    text: String,
    html: String,
    json: Boolean,
    colors: Boolean,
    conf: [ path, false ],
    version: Boolean
  },

  shorthands = {
    s: [ '--subject' ],
    x: [ '--text' ],
    m: [ '--html' ],
    t: [ '--tmpl' ],
    p: [ '--tmpl-path' ],
    d: [ '--data' ],
    c: [ '--conf' ],
    j: [ '--json' ],
    n: [ '--no-colors' ],
    "?": [ '--help' ],
    h: [ '--help' ],
    v: [ '--version' ]
  },

  defaults = {
    subject: null,
    text: null,
    html: null,
    tmpl: null,
    tmplPath: null,
    data: null,
    conf: process.env.HOME + '/.horseshoe.json',
    json: false,
    colors: true,
    help: false,
    version: false
  },

  options = nopt(knownOpts, shorthands);

if (options.version) {
  console.log(require("../package.json").version);
  process.exit(0);
}

if (options.help || !options.argv.remain.length) {
  console.log([
    '',
    'Usage:'.bold,
    '',
    'horseshoe [ <options> ] <email1> [ <email2> ... ]',
    '',
    'Options:'.bold,
    '',
    '-s  --subject     The message subject.',
    '-x  --text        The plain text message body.',
    '-m  --html        HTML content.',
    '-t  --tmpl        Handlebars template.',
    '-p  --tmpl-path   Path to Handlebars template files.',
    '-d  --data        Data to be used as context for Handlebars template.',
    '-c  --conf        Path to config file. Default is $HOME/.horseshoe.json',
    '-j  --json        Output in JSON format.',
    '-n  --no-colors   Dont do output colouring.',
    '-h  --help        Show this screen you are looking at.',
    '-v  --version     Show horseshoe\'s version number.',
    '',
    'Examples:'.bold,
    '',
    '1. Send plain text email using options:',
    '',
    'horseshoe ' + '-s "the subject"'.green + ' -t "simple text body"'.yellow +
      ' someone@somewhere.com'.cyan,
    '',
    '2. Send plain text email piping body into horseshoe:',
    '',
    'echo ' + '"the body"'.green + ' | horseshoe' + ' -s "the subject"'.yellow +
      ' someone@somewhere.com'.cyan,
    '',
    '3. Send email using template passing data as argument:',
    '',
    'horseshoe ' + '-s "the subject"'.green + ' -t "simple text body"'.yellow +
      ' someone@somewhere.com'.cyan,
    ''
  ].join('\n'));
  process.exit(0);
}

Object.keys(defaults).forEach(function (k) {
  if (!options.hasOwnProperty(k)) { options[k] = defaults[k]; }
});

// Disable colouring if asked to do so...
if (!options.colors) { colors.mode = 'none'; }

console.log(options);
