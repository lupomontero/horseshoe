<!DOCTYPE html><html lang="en"><head><title>index</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content=""><meta name="groc-document-path" content="index"><meta name="groc-project-path" content="index.js"><meta name="groc-github-url" content="https://github.com/lupomontero/horseshoe"><link rel="stylesheet" type="text/css" media="all" href="assets/style.css"><script type="text/javascript" src="assets/behavior.js"></script><body><div id="meta"><div class="file-path"><a href="https://github.com/lupomontero/horseshoe/blob/master/index.js">index.js</a></div></div><div id="document"><div class="segment"><div class="comments "><div class="wrapper"><h1 id="horseshoe">Horseshoe</h1></div></div></div><div class="segment"><div class="code"><div class="wrapper"><span class="hljs-keyword">var</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">'path'</span>);
<span class="hljs-keyword">var</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>);
<span class="hljs-keyword">var</span> async = <span class="hljs-built_in">require</span>(<span class="hljs-string">'async'</span>);
<span class="hljs-keyword">var</span> _ = <span class="hljs-built_in">require</span>(<span class="hljs-string">'lodash'</span>);
<span class="hljs-keyword">var</span> Handlebars = <span class="hljs-built_in">require</span>(<span class="hljs-string">'handlebars'</span>);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>If <code>nodemailer</code> has been defined globally we use that. This allows us to
easily replace <code>nodemailer</code> with a mockup when running tests.</p></div></div><div class="code"><div class="wrapper"><span class="hljs-keyword">var</span> nodemailer = global.nodemailer || <span class="hljs-built_in">require</span>(<span class="hljs-string">'nodemailer'</span>);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Default options.</p></div></div><div class="code"><div class="wrapper"><span class="hljs-keyword">var</span> defaults = {
  tmplPath: path.join(process.cwd(), <span class="hljs-string">'mail_templates'</span>),
  tmplCache: {}
};</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="horseshoe">Horseshoe</h2></div></div></div><div class="segment"><div class="code"><div class="wrapper"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Horseshoe</span><span class="hljs-params">(type, opt)</span> </span>{
  <span class="hljs-keyword">this</span>.type = type;
  <span class="hljs-keyword">this</span>.options = _.extend({}, defaults, opt);
}</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="horseshoesend">Horseshoe.send()</h2></div></div></div><div class="segment"><div class="code"><div class="wrapper">Horseshoe.prototype.send = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(msg, cb)</span> </span>{
  <span class="hljs-keyword">var</span> transport = <span class="hljs-keyword">this</span>._createTransport();
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._send(transport, msg, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, res)</span> </span>{
    transport.close(); <span class="hljs-comment">// Make sure we close de transport pool when done!</span>
    cb(err, res);
  });
};</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Send a single email message.</p></div></div><div class="code"><div class="wrapper">Horseshoe.prototype._send = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(transport, msg, cb, retries, errors)</span> </span>{
  <span class="hljs-keyword">var</span> that = <span class="hljs-keyword">this</span>;

  <span class="hljs-keyword">if</span> (!retries) { retries = <span class="hljs-number">0</span>; }
  <span class="hljs-keyword">if</span> (!errors) { errors = []; }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Check if errors so far contain fatal errors. If so we won&#39;t retry.</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-keyword">var</span> fatalErrors = errors.filter(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(error)</span> </span>{
    <span class="hljs-keyword">return</span> [ <span class="hljs-string">'AuthError'</span> ].indexOf(error.name) &gt;= <span class="hljs-number">0</span>;
  });

  <span class="hljs-keyword">if</span> (retries &gt; <span class="hljs-number">2</span> || fatalErrors.length) {
    <span class="hljs-keyword">var</span> err = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'Failed sending email after '</span> + retries + <span class="hljs-string">' attempt(s).'</span>);
    err.msg = msg;
    err.transport = transport;
    err.attempts = errors;
    <span class="hljs-keyword">return</span> cb(err);
  }

  that.render(msg, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
    <span class="hljs-keyword">if</span> (err) { <span class="hljs-keyword">return</span> cb(err); }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Set default sender if exists as transport option.</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">if</span> (!msg.sender &amp;&amp; transport.options.sender) {
      msg.sender = transport.options.sender;
    }
    transport.sendMail(msg, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, res)</span> </span>{
      <span class="hljs-keyword">if</span> (err) {
        errors.push(err);
        <span class="hljs-keyword">return</span> that._send(transport, msg, cb, ++retries, errors);
      }
      res.messageObject = msg;
      cb(<span class="hljs-literal">null</span>, res);
    });
  });
};

<span class="hljs-keyword">var</span> formats = [
  {
    name: <span class="hljs-string">'text'</span>,
    ext: <span class="hljs-string">'txt'</span>,
    parse: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(msg, body)</span> </span>{
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> body !== <span class="hljs-string">'string'</span>) { <span class="hljs-keyword">return</span>; }
      <span class="hljs-keyword">var</span> textTmplRawArray = body.split(<span class="hljs-string">'\n'</span>);
      <span class="hljs-keyword">if</span> (!msg.subject) {
        msg.subject = textTmplRawArray.shift();
        textTmplRawArray.shift(); <span class="hljs-comment">// remove empty line after subject line</span>
      }
      msg.text = textTmplRawArray.join(<span class="hljs-string">'\n'</span>);
    }
  },
  {
    name: <span class="hljs-string">'html'</span>,
    parse: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(msg, body)</span> </span>{
      msg.html = body;
      <span class="hljs-keyword">if</span> (!msg.subject) {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>TODO: msg.subject = // get page title using cheerio...</p></div></div><div class="code"><div class="wrapper">      }
    }
  }
];</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="horseshoerender">Horseshoe.render()</h2>
<p>Render a message object before sending.</p></div></div><div class="code"><div class="wrapper">Horseshoe.prototype.render = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(msg, cb)</span> </span>{
  <span class="hljs-keyword">var</span> that = <span class="hljs-keyword">this</span>;
  <span class="hljs-keyword">var</span> cache = that.options.tmplCache;
  <span class="hljs-keyword">var</span> tmplPath = that.options.tmplPath;
  <span class="hljs-keyword">var</span> template = msg.template;

  <span class="hljs-keyword">if</span> (!template) { <span class="hljs-keyword">return</span> cb(<span class="hljs-literal">null</span>); }
  <span class="hljs-keyword">if</span> (!msg.data) { msg.data = {}; }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Render both <code>html</code> and <code>txt</code> templates. If files are not found...?</p></div></div><div class="code"><div class="wrapper">  async.each(formats, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(format, cb)</span> </span>{
    <span class="hljs-keyword">var</span> key = format.name;
    <span class="hljs-keyword">var</span> file = path.join(tmplPath, template + <span class="hljs-string">'.'</span> + (format.ext || key));</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>If template is already cached no need to re-compile.</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">if</span> (_.isFunction(cache[file])) {
      format.parse(msg, cache[file](msg.data));
      <span class="hljs-keyword">return</span> cb();
    }
    that.compile(file, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(fn)</span> </span>{
      <span class="hljs-keyword">try</span> {
        format.parse(msg, fn(msg.data));
      } <span class="hljs-keyword">catch</span> (exception) {
        <span class="hljs-keyword">return</span> cb(exception);
      }
      cache[file] = fn;
      cb();
    });
  }, cb);
};</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="horseshoecompile">Horseshoe.compile()</h2>
<p>Compile a Handlebars template from file. If file doesn&#39;t exist or can not be
read no error will be raised. The callback will be invoked passing a dummy
template function that does nothing.
NOTE: callback will be invoked with only one argument as no errors can be
raised.</p></div></div><div class="code"><div class="wrapper">Horseshoe.prototype.compile = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(fname, cb)</span> </span>{
  fs.exists(fname, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(exists)</span> </span>{
    <span class="hljs-keyword">if</span> (!exists) { <span class="hljs-keyword">return</span> cb(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{}); }
    fs.readFile(fname, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, source)</span> </span>{
      <span class="hljs-keyword">if</span> (err) { <span class="hljs-keyword">return</span> cb(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{}); }
      cb(Handlebars.compile(source.toString()));
    });
  });
};

Horseshoe.prototype._createTransport = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">return</span> nodemailer.createTransport(<span class="hljs-keyword">this</span>.type, <span class="hljs-keyword">this</span>.options);
};

<span class="hljs-built_in">module</span>.exports = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(type, opt)</span> </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Horseshoe(type, opt);
};</div></div></div></div></body></html>